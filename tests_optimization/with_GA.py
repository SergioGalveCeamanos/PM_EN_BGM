# -*- coding: utf-8 -*-
"""
Created on Fri Dec 10 09:37:41 2021

@author: sega01
"""
import numpy as np
import pandas as pd
import pickle
import copy
from matplotlib import cm as CM
from matplotlib.lines import Line2D
from elasticsearch import Elasticsearch
import pickle
from cvxopt import solvers, matrix, spdiag, log, exp, div
import numpy as np
import random
import matplotlib.pyplot as plt
import seaborn as sns
from matplotlib.patches import Ellipse
import matplotlib.transforms as transforms
import pickle
import datetime
import math

if False:
    def get_index_analytics(date, ty):
        index = ty+date[5:7]+date[0:4]
        return index
    
    def get_analytics(client, time_start, time_stop, device, version, names_analysis):
             ty = 'pm_bgm_data_'  # 'pm_bgm_data_'
             ind = get_index_analytics(time_start, ty)
             response = client.search(
                index=ind,
                body={
                      "query": {
                        "bool": {
                          # Also: filter, must_not, should
                          "must": [
                            {
                              "match": {
                                "device": device
                              }
                            },
                            {
                              "match": {
                                "trained_version": version
                              }
                            },
                            {
                            "range": {
                            # Timestap format= "2019-12-30T09:25:20.000Z"
                            "timestamp": {
                            "gt": time_start,  # Date Format in Fault Manager: '2019-05-02 08:00:10'
                            "lt": time_stop
                                         }
                                     }
                            }
                          ],
                          "must_not": [],
                          "should": []
                        }
                      },
                      "from": 0,
                      "size": 100,
                      "sort": [{"timestamp": {"order": "asc"}}],
                      "aggs": {}
                    },
                scroll='5m'
             )
             # DATA ARRANGE: each mso will have a dictionary with as many temporal series as in self.names_analysis --> all msos in the list data
             data = []
             first = True
             for hit in response['hits']['hits']:
                 # print(hit)
                 if first:
                     first = False
                     n_msos = len(hit['_source'][names_analysis[0]])
                     for i in range(n_msos):
                         new_mso = {}
                         for name in names_analysis:
                             field = hit['_source'][name]
                             if name == 'timestamp':
                                 new_mso[name] = [field]
                             else:
                                 new_mso[name] = [field[i]]
                         data.append(new_mso)
                 else:
                     for i in range(n_msos):
                         for name in names_analysis:
                             field = hit['_source'][name]
                             if name == 'timestamp':
                                 data[i][name].append(field)
                             else:
                                 data[i][name].append(field[i])
    
             sc_id = response['_scroll_id']
             more = True
             while more:
                 sc = client.scroll(scroll_id=sc_id, scroll='2m')  # ,scroll='1m'
                 # sc_id=response['_scroll_id']
                 if len(sc['hits']['hits']) == 0:  # || total>20
                     more = False
                 else:
                     for hit in sc['hits']['hits']:
                         if len(hit['_source'][names_analysis[0]]) == n_msos:
                             for i in range(n_msos):
                                 for name in names_analysis:
                                     field = hit['_source'][name]
                                     if name == 'timestamp':
                                         data[i][name].append(field)
                                     else:
                                         data[i][name].append(field[i])
                         else:
                             print('  [!] WARNING: The gathered analysis data might come from different models, two sizes of MSO_SET: '+str(
                                 len(hit['_source'][names_analysis[0]]))+', '+str(n_msos)+'  | timestamp: '+hit['_source']['timestamp'])
    
             return data
    
    def get_telemetry(client,time_start, time_stop, device, var):
             ty='telemetry_'
             ind=get_index_analytics(time_start,ty) 
             response = client.search(
                index=ind,
                body={
                      "query": {
                        "bool": {
                          # Also: filter, must_not, should
                          "must": [ 
                            {
                              "match": {
                                "deviceId": device
                              }
                            },
                            {
                              "match": {
                                "aggregationSeconds": 1
                              }
                            },
                            {
                              "match": {
                                # name of the variable from sensors
                                "param": var 
                              }
                            },
                            {
                            "range": {
                            # Timestap format= "2019-12-30T09:25:20.000Z"
                            "timestamp": { 
                            "gt": time_start, # Date Format in Fault Manager: '2019-05-02 08:00:10'
                            "lt": time_stop 
                                         }
                                     }
                            }
                          ],
                          "must_not": [],
                          "should": []
                        }
                      },
                      "from": 0,
                      "size": 100,
                      "sort": [{ "timestamp" : {"order" : "asc"}}],
                      "aggs": {}
                    },
                scroll='5m'
             )
             # DATA ARRANGE: each mso will have a dictionary with as many temporal series as in self.names_analysis --> all msos in the list data
             data={}
             for hit in response['hits']['hits']:
                 #print(hit)
                 data[hit['_source']['timestamp']]=hit['_source']['avg']
                
             sc_id=response['_scroll_id']
             more=True
             while more:
                 sc=client.scroll(scroll_id=sc_id,scroll='2m') # ,scroll='1m'
                 #sc_id=response['_scroll_id']
                 if len(sc['hits']['hits'])==0: #|| total>20
                     more=False
                 else:
                     for hit in sc['hits']['hits']:
                         data[hit['_source']['timestamp']]=hit['_source']['avg']
                         
             return data
         
    def fix_dict(d):
        new_d = {}
        for n in d:
            new_d[int(n)] = d[n]
        return new_d
    
    if True:
        device = 74124
        # fault_mso_sentivitity for version: "_test_I_ClustSegm_180621_v1"
        fault_mso_sensitivity = {10: {'fc3': {0: 0.014702806019391147, 1: 0.0, 2: 0.0023195391867075247, 3: 0.02917796795049289, 4: 0.020672063018461945}, 'fc4': {0: 0.08007573438061659, 1: 0.1048629497587624, 2: 0.0713212918762229, 3: 0.13329612734283663, 4: 0.041636680084586715}, 'fl1': {0: 0.014702806019391147, 1: 0.0, 2: 0.014134438533967246, 3: 0.02917796795049289, 4: 0.03721127433952668}, 'fo2': {0: 0.05100334050519008, 1: 0.03739915332905163, 2: 0.01599296485772877, 3: 0.06720300360473301, 4: 0.018738049211492677}, 'fo3': {0: 0.14830814971761333, 1: 0.145847440693686, 2: 0.1548109014243899, 3: 0.05239000936405426, 4: 0.03295773250651927}, 'fs2': {0: 0.029072393875426508, 1: 0.06746379642971076, 2: 0.05532832701849414, 3: 0.0660931237381036, 4: 0.022898630873094034}, 'fs3': {0: 0.10080425028264847, 1: 0.11931109970511898, 2: 0.0814596652745466, 3: 0.13257991240821024, 4: 0.11063143240275748}, 'fs5': {0: 0.05100334050519008, 1: 0.03739915332905163, 2: 0.01599296485772877, 3: 0.06720300360473301, 4: 0.018738049211492677}, 'fs6': {0: 0.14830814971761333, 1: 0.145847440693686, 2: 0.1548109014243899, 3: 0.05239000936405426, 4: 0.03295773250651927}, 'fc2': {0: 0.280905516908675, 1: 0.27389886580368517, 2: 0.2901078028863611, 3: 0.2959541044274075, 4: 0.17690304823714265}, 'fs9': {0: 0.0405410799292701, 1: 0.019208618082366645, 2: 0.08037899955219856, 3: 0.03022412988526937, 4: 0.20319864779858407}, 'fs10': {0: 0.040572432138973914, 1: 0.048761482174880806, 2: 0.06334220310726447, 3: 0.03196714106846293, 4: 0.0}, 'fs8': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.012343499291149489, 4: 0.2834566598098227}}, 16: {'fc1': {0: 0.4841311511731264, 1: 0.4920719664915089, 2: 0.495359903864218}, 'fs2': {0: 0.06175060987070388, 1: 0.06345349918457671, 2: 0.04685274711989728}, 'fs3': {0: 0.12383562851895524, 1: 0.1355077011154559, 2: 0.14103094975120162}, 'fs5': {0: 0.16519505574061097, 1: 0.15208479516208095, 2: 0.13090375558809925}, 'fs6': {0: 0.1223170423438215, 1: 0.13961362873748243, 2: 0.168645583478064}, 'fl1': {0: 0.04277051235278214, 1: 0.017268409308895075, 2: 0.01720706019851993}}, 30: {'fc1': {0: 0.2370940361818125, 1: 0.2694741166692367, 2: 0.23583826791765725, 3: 0.22455639247786316, 4: 0.23298832446866985}, 'fc5': {0: 9.184935529066003e-05, 1: 1.0924661553398257e-06, 2: 0.0004683726170091345, 3: 0.0037451036942574584, 4: 0.0009663989601400383}, 'fc3': {0: 0.014692145637859694, 1: 0.0006097565281819215, 2: 0.004943869771196586, 3: 0.024278058787204695, 4: 0.026945157695436}, 'fc4': {0: 0.036125639328360104, 1: 0.06163610103021877, 2: 0.04508142095138226, 3: 0.07252111023634754, 4: 0.01706157692207466}, 'fo2': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0, 4: 0.0}, 'fo3': {0: 0.11987215917781632, 1: 0.10430894251130668, 2: 0.12109289516583362, 3: 0.04048888827204571, 4: 0.05211823047643781}, 'fc2': {0: 0.23031743864044618, 1: 0.22000700221641278, 2: 0.2287624799687663, 3: 0.25060873998837735, 4: 0.24564057762140054}, 'fs8': {0: 0.037123638806504794, 1: 0.014253510884443663, 2: 0.07309275295281223, 3: 0.10864217098426573, 4: 0.1432452846014636}, 'fs10': {0: 0.07280506169694705, 1: 0.059624512030470166, 2: 0.04946943034947981, 3: 0.02257998060031287, 4: 0.02013456813013173}, 'fl1': {0: 0.017948202457839273, 1: 0.006345377934824397, 2: 0.014245484927987925, 3: 0.026438785885357603, 4: 0.036408925734023864}, 'fs2': {0: 0.036125639328360104, 1: 0.06163610103021877, 2: 0.04508142095138226, 3: 0.07252111023634754, 4: 0.01706157692207466}, 'fs3': {0: 0.07784018085565647, 1: 0.09779345172106875, 2: 0.06036233664365003, 3: 0.10938566687131701, 4: 0.15434474903156953}, 'fs6': {0: 0.11987215917781632, 1: 0.10430894251130668, 2: 0.12109289516583362, 3: 0.04048888827204571, 4: 0.05211823047643781}, 'fs12': {0: 9.184935529066003e-05, 1: 1.0924661553398257e-06, 2: 0.0004683726170091345, 3: 0.0037451036942574584, 4: 0.0009663989601400383}}, 41: {'fc1': {0: 0.24152795268695212, 1: 0.23943392840079983, 2: 0.23970629137766816, 3: 0.13838049410417377, 4: 0.2249179856718699}, 'fl1': {0: 0.0023454505057384596, 1: 0.014502718545984613, 2: 0.020732150683205167, 3: 0.03884032093209827, 4: 0.023831023071854484}, 'fc3': {0: 0.0012814920157958353, 1: 0.009740084528143051, 2: 0.009842855011106577, 3: 0.016404523175093232, 4: 0.01876916230121003}, 'fc4': {0: 0.10662428206851611, 1: 0.09177077343016157, 2: 0.11060467366562175, 3: 0.01240420506824594, 4: 0.12436500022097188}, 'fo2': {0: 0.10662428206851611, 1: 0.09177077343016157, 2: 0.11060467366562175, 3: 0.01240420506824594, 4: 0.12436500022097188}, 'fo3': {0: 0.08426247222770064, 1: 0.09634489405394499, 2: 0.0769310491316329, 3: 0.01250239431981746, 4: 0.025870253227902994}, 'fc2': {0: 0.157442876633012, 1: 0.18008828110616842, 2: 0.14890158915744295, 3: 0.14063888809133307, 4: 0.1584659594155962}, 'fs9': {0: 0.0022135242537884817, 1: 0.0, 2: 0.013899837089887901, 3: 0.196050395263986, 4: 0.03283922012861072}, 'fs8': {0: 0.054699250214381226, 1: 0.040306075996957895, 2: 0.03675735259437954, 3: 0.3162237544078266, 4: 0.04387699465983583}, 'fs1': {0: 0.0025144231285896164, 1: 0.0013711761247199822, 2: 0.003202531917863666, 3: 0.00020612322201091134, 4: 0.0028432761799505866}, 'fs3': {0: 0.04957723990079278, 1: 0.0465556268988517, 2: 0.04128127290831491, 3: 0.09103809695910534, 4: 0.06962087145235056}, 'fs5': {0: 0.10662428206851611, 1: 0.09177077343016157, 2: 0.11060467366562175, 3: 0.01240420506824594, 4: 0.12436500022097188}, 'fs6': {0: 0.08426247222770064, 1: 0.09634489405394499, 2: 0.0769310491316329, 3: 0.01250239431981746, 4: 0.025870253227902994}}, 52: {'fc1': {0: 0.20856745296434276, 1: 0.22148098660175258, 2: 0.21241006593451114, 3: 0.21506087713103636, 4: 0.21809024810522443}, 'fc3': {0: 0.017754649969651783, 1: 0.020632270360804904, 2: 0.0008148740138301373, 3: 0.008355475171403478, 4: 0.0}, 'fc4': {0: 0.19827333749806697, 1: 0.16641405410326984, 2: 0.2108902152356844, 3: 0.2053631921382826, 4: 0.20971137257720288}, 'fo2': {0: 0.15912312832388387, 1: 0.1362757162194914, 2: 0.16023104985795755, 3: 0.1548593943809486, 4: 0.15266098398120495}, 'fo3': {0: 0.0, 1: 0.027995515589221025, 2: 0.0, 3: 0.0003505156444789905, 4: 0.007473333371406931}, 'fc2': {0: 0.01242313606588644, 1: 0.07458793437322658, 2: 0.0061056948712266855, 3: 0.011439246509025353, 4: 0.012388471400840062}, 'fs9': {0: 0.12865602007406754, 1: 0.04516564980351539, 2: 0.06829597139584564, 3: 0.08166280482986543, 4: 0.04180150827068901}, 'fs10': {0: 0.04888017217010612, 1: 0.06533461598616074, 2: 0.08198645446043963, 3: 0.09949214189251938, 4: 0.1397838341882074}, 'fl1': {0: 0.0280487654359276, 1: 0.04770368727006666, 2: 0.0023347247126568565, 3: 0.01770264451967823, 4: 0.0009055421566145921}, 'fs2': {0: 0.039150209174183104, 1: 0.03013833788377843, 2: 0.0506591653777269, 3: 0.050503797757334025, 4: 0.05705038859599794}, 'fs5': {0: 0.15912312832388387, 1: 0.1362757162194914, 2: 0.16023104985795755, 3: 0.1548593943809486, 4: 0.15266098398120495}, 'fs6': {0: 0.0, 1: 0.027995515589221025, 2: 0.0, 3: 0.0003505156444789905, 4: 0.007473333371406931}, 'fs8': {0: 0.0, 1: 0.0, 2: 0.04604073428216359, 3: 0.0, 4: 0.0}}, 86: {'fc1': {0: 0.2254095099237621, 1: 0.30748256373306204, 2: 0.23695955407035083, 3: 0.2377596989845182, 4: 0.2565641701189724}, 'fc3': {0: 0.0, 1: 0.003944874638355299, 2: 0.021123056260052127, 3: 0.023915936894094648, 4: 0.01444890049830529}, 'fc4': {0: 0.04314051459830806, 1: 0.07995123790232296, 2: 0.09360734836071019, 3: 0.11072678078024213, 4: 0.12189026102312442}, 'fo2': {0: 0.0, 1: 0.0, 2: 0.04769012271976019, 3: 0.058756765323078435, 4: 0.07995007518203234}, 'fo3': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0, 4: 0.0}, 'fc2': {0: 0.36048638180950754, 1: 0.28229597372409115, 2: 0.26478878000047873, 3: 0.2586293898556112, 4: 0.1751529594216259}, 'fs9': {0: 0.13832621598041805, 1: 0.0, 2: 0.06731512619441145, 3: 0.04571862645602014, 4: 0.0}, 'fc5': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0, 4: 0.0}, 'fs10': {0: 0.0, 1: 0.0, 2: 0.002887733529602618, 3: 0.0, 4: 0.06366037236649687}, 'fl1': {0: 0.04746249297701028, 1: 0.0715839793467591, 2: 0.05472775574023585, 3: 0.03667815684705435, 4: 0.021209633832870813}, 'fs11': {0: 0.0036139338821210855, 1: 0.007448955815375583, 2: 0.003772834267115389, 3: 0.0014085829139110417, 4: 0.008660095386082605}, 'fo5': {0: 0.0036139338821210855, 1: 0.007448955815375583, 2: 0.003772834267115389, 3: 0.0014085829139110417, 4: 0.008660095386082605}, 'fs2': {0: 0.04314051459830806, 1: 0.07995123790232296, 2: 0.04591722564095, 3: 0.05197001545716369, 4: 0.04194018584109206}, 'fs3': {0: 0.1348065023484437, 1: 0.15989222112233525, 2: 0.10974750622945692, 3: 0.1142706982513164, 4: 0.12791317576128247}, 'fs5': {0: 0.0, 1: 0.0, 2: 0.04769012271976019, 3: 0.058756765323078435, 4: 0.07995007518203234}}}
        
        # _test_I_260521,_test_II_StabilityFilt_260521,_test_VI_StabilityFilt_090621
        v = "_test_III_NotifSyst_181021"#"_test_I_ClustSegm_180621_v1"
        
        if v == "_test_I_260521":
            fault_mso_sensitivity = {10: {'fc3': [0.035903998271201484, 0.0064824975770429805, 0.036977369455424985, 0.0, 0.01823859234591566], 'fc4': [0.08814765704461945, 0.04248315386259618, 0.12539959130400985, 0.08469994595306575, 0.17168589029441744], 'fl1': [0.047135740471734924, 0.008281676086642466, 0.06264743001525995, 0.0, 0.01823859234591566], 'fo2': [0.0, 7.239963823862627e-05, 0.10084842664488405, 0.027464008751678096, 0.09272578249811118], 'fo3': [0.12617213884043169, 0.0434853459634525, 0.09260277709067584, 0.07014000270246132, 0.0818327192433409], 'fs2': [0.08814765704461945, 0.04241075422435755, 0.024551164659125806, 0.05723593720138766, 0.07896010779630626], 'fs3': [0.10756503166262438, 0.05607645354586309, 0.10585982923523733, 0.0706670128147635, 0.11053473452801119], 'fs5': [0.0, 7.239963823862627e-05, 0.10084842664488405, 0.027464008751678096, 0.09272578249811118], 'fs6': [0.12617213884043169, 0.0434853459634525, 0.09260277709067584, 0.07014000270246132, 0.0818327192433409], 'fc2': [0.2596531119918792, 0.11038464808391393, 0.22413266688574818, 0.1582413157193076, 0.20861707206775423], 'fs9': [0.11346686610664135, 0.3545223859310853, 0.03352954097407399, 0.21855219131246495, 0.024147259870354695], 'fs10': [0.0, 0.0011941745654448412, 0.0, 0.034037513154392615, 0.020460747268420634], 'fs8': [0.00763565972581641, 0.2910487649196714, 0.0, 0.18135806093633902, 0.0]}, 16: {'fc1': [0.4981737519082215, 0.48766544143208257, 0.4793542806469006, 0.4925953533063003, 0.48823140902189016], 'fs2': [0.03470527133712724, 0.06578982566278685, 0.037815754171201366, 0.05820925402470152, 0.07436479443228859], 'fs3': [0.1279174595256942, 0.15015280406208298, 0.13523612894154066, 0.1477808934631628, 0.14019562077980596], 'fs5': [0.2011038336852787, 0.11994541702264525, 0.1502629158769238, 0.12197828285413549, 0.13961919435274858], 'fs6': [0.13368247418560203, 0.15097868262997116, 0.14039181550252988, 0.14685622482167043, 0.12315682626683219], 'fl1': [0.00441720935807635, 0.025467829190431113, 0.05693910486090357, 0.032579991530029453, 0.03443215514643444]}, 30: {'fc1': [0.272148197498368, 0.24181442013299145, 0.2366448743419905, 0.210585462593206, 0.2527127916733255, 0.23779669278352944, 0.24415908235296388, 0.2563397633481321], 'fc5': [0.002027458680100215, 0.002773039935287352, 0.0005533044831658862, 0.009818950471910653, 0.0005733815251981321, 0.0013405625204526562, 0.0007771780545361509, 0.0024479249795411164], 'fc3': [0.0, 0.024161901161231108, 0.025719831583578427, 0.020088488529481262, 0.017045155012274906, 0.005438712697060586, 0.012030525074712379, 0.047798847139575294], 'fc4': [0.0880959979494743, 0.050764052702882576, 0.049248032035166873, 0.03560836728242409, 0.06607143338348725, 0.06251040248088967, 0.04256971135563526, 0.05292034075112266], 'fo2': [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], 'fo3': [0.07395567008406152, 0.07400325391010285, 0.08614386421426898, 0.0436732671834756, 0.10165855169464824, 0.10239578930667029, 0.09272500250503292, 0.08980855781789386], 'fc2': [0.187093384741011, 0.19135524530655307, 0.19332349481542435, 0.19512496268432516, 0.18958504850563984, 0.19397868799767812, 0.22226803679778398, 0.2278669857734589], 'fs8': [0.0, 0.08333398434160047, 0.06860955955443018, 0.13671283513135005, 0.02831198423889747, 0.06782098391191216, 0.015983477115568263, 4.689489624757909e-05], 'fs10': [0.10250363486851674, 0.06304474127984117, 0.07683902856324012, 0.10789476452922918, 0.07371032575573032, 0.08414220030076451, 0.112520201261555, 0.016184149826779994], 'fl1': [0.01207199338448376, 0.04847613134371312, 0.03601154114822268, 0.06280508486253246, 0.03087139884968592, 0.017781630482070727, 0.01615813331479884, 0.0507437646420442], 'fs2': [0.0880959979494743, 0.050764052702882576, 0.049248032035166873, 0.03560836728242409, 0.06607143338348725, 0.06251040248088967, 0.04256971135563526, 0.05292034075112266], 'fs3': [0.09802453608034835, 0.09273288333752402, 0.09096126852791042, 0.08858723179425515, 0.07115656275777897, 0.06054758321095932, 0.10473676025220921, 0.11066594727664665], 'fs6': [0.07395567008406152, 0.07400325391010285, 0.08614386421426898, 0.0436732671834756, 0.10165855169464824, 0.10239578930667029, 0.09272500250503292, 0.08980855781789386], 'fs12': [0.002027458680100215, 0.002773039935287352, 0.0005533044831658862, 0.009818950471910653, 0.0005733815251981321, 0.0013405625204526562, 0.0007771780545361509, 0.0024479249795411164]}, 41: {'fc1': [0.26029776732423554, 0.19148829874893508, 0.238896745596163,
                0.16422015307616084, 0.2642728739821142, 0.2609478272130474], 'fl1': [0.04087225584931388, 0.02003333328362892, 0.008181247758814908, 0.027139097311237665, 0.008836756097316153, 0.02095426265552429], 'fc3': [0.017595201186061962, 0.00733848889173289, 0.007906687592961996, 0.014450628795096957, 0.0013590310273666585, 0.010976767793276623], 'fc4': [0.09049561203272047, 0.0897451078684531, 0.1233763246549427, 0.05805063171626947, 0.10862958463696842, 0.09067055709834215], 'fo2': [0.09049561203272047, 0.0897451078684531, 0.1233763246549427, 0.05805063171626947, 0.10862958463696842, 0.09067055709834215], 'fo3': [0.05596346910443041, 0.03705652819228625, 0.05505318457258675, 0.03834839720375727, 0.0857486925469422, 0.09084839167891264], 'fc2': [0.18757501993841907, 0.10841332679521509, 0.1164280812818987, 0.1116674951484324, 0.1648961211769332, 0.18396130411175493], 'fs9': [0.013398093236884066, 0.10348439927562231, 0.011390701711086169, 0.1582369878173472, 0.0, 0.0], 'fs8': [0.0, 0.17288187214549927, 0.07153362504244695, 0.2173743191785651, 0.0, 0.0], 'fs1': [0.0062862566342304195, 0.0010200825731349226, 0.005234891703846018, 0.0009299734768434102, 0.0008322069832260279, 0.0], 'fs3': [0.09056163152383277, 0.0519918182962997, 0.06019267620278065, 0.05513265563999341, 0.06241687172825407, 0.06945138357354497], 'fs5': [0.09049561203272047, 0.0897451078684531, 0.1233763246549427, 0.05805063171626947, 0.10862958463696842, 0.09067055709834215], 'fs6': [0.05596346910443041, 0.03705652819228625, 0.05505318457258675, 0.03834839720375727, 0.0857486925469422, 0.09084839167891264]}, 52: {'fc1': [0.2197909264649741, 0.2188907796487518, 0.21754531590538365, 0.2181005600708864, 0.21697268147345905], 'fc3': [0.003959417470575125, 0.009633532931425694, 0.0021316446691884124, 0.029853845277973412, 0.01731394425801682], 'fc4': [0.2129787790289674, 0.20528542061240085, 0.20362618146160505, 0.18133116934088064, 0.20441502455677826], 'fo2': [0.14461682603766685, 0.14592640704458662, 0.14679591659694588, 0.1383617459718705, 0.1443515660511115], 'fo3': [0.0018213837724241567, 0.0008143314102266744, 0.007852015830793167, 0.012192695684771588, 0.0], 'fc2': [0.008315874298111816, 0.013605359036350958, 0.016261416483601816, 0.03676939073000576, 0.012880555848664365], 'fs9': [0.03165996620146253, 0.07338621539198871, 0.09188941394758122, 0.07184205659408491, 0.04042589199884082], 'fs10': [0.13866912753679783, 0.10393364134409142, 0.0942211345303287, 0.0635941309806668, 0.11734573981313193], 'fl1': [0.008950181134157723, 0.022424560557549975, 0.008198763282173878, 0.054430540323207585, 0.029871601174697632], 'fs2': [0.0683619529913005, 0.05935901356781424, 0.056830264864659134, 0.042969423369010135, 0.06006345850566677], 'fs5': [0.14461682603766685, 0.14592640704458662, 0.14679591659694588, 0.1383617459718705, 0.1443515660511115], 'fs6': [0.0018213837724241567, 0.0008143314102266744, 0.007852015830793167, 0.012192695684771588, 0.0], 'fs8': [0.014437355253470995, 0.0, 0.0, 0.0, 0.012007970268521302]}, 86: {'fc1': [0.2682523636233243, 0.23946616766764475, 0.2560907228069728, 0.22914029153140683, 0.25242140459347423], 'fc3': [0.04986334473632703, 0.028629543601443225, 0.02119235027728986, 0.013396379212171801, 0.0048201506714945315], 'fc4': [0.12093154266990366, 0.1020373284929783, 0.06626302199854534, 0.08173578078714745, 0.08123964174194497], 'fo2': [0.043438085287627055, 0.0, 0.018198090296024313, 0.01672060637612683, 0.0], 'fo3': [0.0, 0.0, 0.0, 0.0, 0.0], 'fc2': [0.16469384467516954, 0.17404134335797458, 0.21993721728853144, 0.16603233394841674, 0.24694227092591262], 'fs9': [0.0, 0.13644914621811835, 0.1266735755079946, 0.11523592542313368, 0.14693923283252694], 'fc5': [0.0, 0.0, 0.0, 0.0, 0.0], 'fs10': [0.02745441599168061, 0.03448804114675624, 0.0, 0.10204405697245299, 0.004921150466610333], 'fl1': [0.08139895106886821, 0.0660004569086108, 0.08473247082777668, 0.05200632646873316, 0.05626975591369789], 'fs11': [0.0036253473281582125, 0.00839635912299831, 0.007180974370189369, 0.016578977502782515, 0.0027372967515339017], 'fo5': [0.0036253473281582125, 0.00839635912299831, 0.007180974370189369, 0.016578977502782515, 0.0027372967515339017], 'fs2': [0.0774934573822766, 0.1020373284929783, 0.04806493170252103, 0.06501517441102063, 0.08123964174194497], 'fs3': [0.11578521462087948, 0.10005792586749887, 0.12628758025794065, 0.108794563487698, 0.11973215760932582], 'fs5': [0.043438085287627055, 0.0, 0.018198090296024313, 0.01672060637612683, 0.0]}}
        elif v == "_test_III_NewConf_220721":
            fault_mso_sensitivity = {10: {'fc3': {0: 0.007820950009105487, 1: 0.0, 2: 0.039314078152276104, 3: 0.008734133093246372}, 'fc4': {0: 0.26004025518508744, 1: 0.25485840469728616, 2: 0.20474078718157943, 3: 0.26048749639171054}, 'fl1': {0: 0.017456694501350095, 1: 0.011195591930206328, 2: 0.07486464037868992, 3: 0.01666760774598133}, 'fo2': {0: 0.18162006203002257, 1: 0.192266967372658, 2: 0.16564814554299118, 3: 0.19078663873652846}, 'fo3': {0: 0.00942109710976652, 1: 0.0110935273223554, 2: 0.03848266377897958, 3: 0.006409555198331429}, 'fs2': {0: 0.0784201931550649, 1: 0.06259143732462819, 2: 0.03909264163858828, 3: 0.06970085765518207}, 'fs3': {0: 0.0015110406581312448, 1: 0.007468145617288012, 2: 0.010220586694110584, 3: 0.002352424013380808}, 'fs5': {0: 0.18162006203002257, 1: 0.192266967372658, 2: 0.16564814554299118, 3: 0.19078663873652846}, 'fs6': {0: 0.00942109710976652, 1: 0.0110935273223554, 2: 0.03848266377897958, 3: 0.006409555198331429}, 'fc2': {0: 0.034026606745555715, 1: 0.029757264869849736, 2: 0.08803950829432763, 3: 0.016695453864447193}, 'fs9': {0: 0.07479885676015477, 1: 0.13657251886386726, 2: 0.05802434118018132, 3: 0.12605822459173177}, 'fs10': {0: 0.14384308470597226, 1: 0.09083564730684746, 2: 0.077441797836305, 3: 0.10491141477460003}, 'fs8': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0}}, 16: {'fc1': {0: 0.45965640939021296, 1: 0.46855547452129437, 2: 0.4498250173535053}, 'fs2': {0: 0.044951856103667226, 1: 0.03164105724079578, 2: 0.04273409636516231}, 'fs3': {0: 0.08673482022197998, 1: 0.08471200705465583, 2: 0.08031096520126071}, 'fs5': {0: 0.14415487085689035, 1: 0.12062603503622896, 2: 0.16403229897164281}, 'fs6': {0: 0.11695138098473569, 1: 0.1353769510718837, 2: 0.0966154989943983}, 'fl1': {0: 0.1475506624425139, 1: 0.1590884750751414, 2: 0.16648212311403063}}, 30: {'fc1': {0: 0.18683113859789804, 1: 0.16702164111652118, 2: 0.1668628533380106, 3: 0.2082058329055987}, 'fc5': {0: 0.003188165987846259, 1: 0.002698349594161044, 2: 0.00194445975884554, 3: 0.00022576589902473511}, 'fc3': {0: 0.09225906514202208, 1: 0.15543191715742527, 2: 0.110872813585059, 3: 0.07326427176278753}, 'fc4': {0: 0.028044475689810243, 1: 0.005504894230241024, 2: 0.02551673551899456, 3: 0.015758061735562393}, 'fo2': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0}, 'fo3': {0: 0.05564842076810855, 1: 0.043664814908893665, 2: 0.1095046389681136, 3: 0.13003685116201463}, 'fc2': {0: 0.2687746525340408, 1: 0.26019811363079576, 2: 0.24384899687185743, 3: 0.2893526006208855}, 'fs8': {0: 0.0589403313576522, 1: 0.0, 2: 0.007960527825658578, 3: 0.0}, 'fs10': {0: 0.02403538019485536, 1: 0.04032836149385439, 2: 0.05380884745154547, 3: 0.001460745346715483}, 'fl1': {0: 0.17032177273214089, 1: 0.2249765544061783, 2: 0.13805019093138118, 3: 0.10381600631354457}, 'fs2': {0: 0.028044475689810243, 1: 0.005504894230241024, 2: 0.02551673551899456, 3: 0.015758061735562393}, 'fs3': {0: 0.02507553454986041, 1: 0.04830729472863346, 2: 0.0046641015045802165, 3: 0.031859185457264606}, 'fs6': {0: 0.05564842076810855, 1: 0.043664814908893665, 2: 0.1095046389681136, 3: 0.13003685116201463}, 'fs12': {0: 0.003188165987846259, 1: 0.002698349594161044, 2: 0.00194445975884554, 3: 0.00022576589902473511}}, 41: {'fc1': {0: 0.24090274654610586, 1: 0.23430087264578567, 2: 0.2336634976747631, 3: 0.237046175781309}, 'fl1': {0: 0.03559926137736091, 1: 0.017008852900408628, 2: 0.06630817648452014, 3: 0.03575698204176784}, 'fc3': {0: 0.018681530973580687, 1: 0.0, 2: 0.03897815613911055, 3: 0.017637792418310948}, 'fc4': {0: 0.10778886971665169, 1: 0.12724219945439136, 2: 0.10975820464602955, 3: 0.114384936958635}, 'fo2': {0: 0.10778886971665169, 1: 0.12724219945439136, 2: 0.10975820464602955, 3: 0.114384936958635}, 'fo3': {0: 0.06767491490192344, 1: 0.04149663758553843, 2: 0.06241155003322079, 3: 0.061372731071702526}, 'fc2': {0: 0.1339390306098694, 1: 0.14310010797153008, 2: 0.12390529302873354, 3: 0.122661238822674}, 'fs9': {0: 0.018288953467412553, 1: 0.08697615523726106, 2: 0.02628176183944179, 3: 0.0}, 'fs8': {0: 0.04485169261714792, 1: 0.003360320584208454, 2: 0.020947589236669964, 3: 0.07615139333945248}, 'fs1': {0: 0.0004991139309701956, 1: 0.001980634421107733, 2: 0.0016540889421276374, 3: 0.0016768264496610694}, 'fs3': {0: 0.04852123152375052, 1: 0.04855318270544726, 2: 0.034163722650103166, 3: 0.04316931812751458}, 'fs5': {0: 0.10778886971665169, 1: 0.12724219945439136, 2: 0.10975820464602955, 3: 0.114384936958635}, 'fs6': {0: 0.06767491490192344, 1: 0.04149663758553843, 2: 0.06241155003322079, 3: 0.061372731071702526}}, 52: {'fc1': {0: 0.21909216871950002, 1: 0.21757451040701667, 2: 0.2176175031508308, 3: 0.2169484350282947}, 'fc3': {0: 0.006680985676328449, 1: 0.0, 2: 0.033118685429952395, 3: 0.006870621438574752}, 'fc4': {0: 0.1998178881426656, 1: 0.21001591250352414, 2: 0.18000822218238888, 3: 0.20641224026830607}, 'fo2': {0: 0.14073906987999535, 1: 0.15497017667940674, 2: 0.13787593145627178, 3: 0.1494289477779443}, 'fo3': {0: 0.010067223397787164, 1: 0.0004823988480574768, 2: 0.012236168122779147, 3: 0.003020692051963266}, 'fc2': {0: 0.030343744751683815, 1: 0.00797468512853949, 2: 0.037609280968441954, 3: 0.010536194759988581}, 'fs9': {0: 0.05806528480059931, 1: 0.11809074027652339, 2: 0.05757201672420531, 3: 0.08915668180228278}, 'fs10': {0: 0.10942048023561199, 1: 0.07331706574991534, 2: 0.07322600338434637, 3: 0.09380713040577611}, 'fl1': {0: 0.015888042855375723, 1: 0.007076199055435069, 2: 0.058491798275615216, 3: 0.014386124146600064}, 'fs2': {0: 0.059078818262670245, 1: 0.055045735824117384, 2: 0.04213229072611708, 3: 0.05698329249036179}, 'fs5': {0: 0.14073906987999535, 1: 0.15497017667940674, 2: 0.13787593145627178, 3: 0.1494289477779443}, 'fs6': {0: 0.010067223397787164, 1: 0.0004823988480574768, 2: 0.012236168122779147, 3: 0.003020692051963266}, 'fs8': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0}}, 86: {'fc1': {0: 0.2148356371565011, 1: 0.21708844420342896, 2: 0.21366345837819414, 3: 0.21798904252819098}, 'fc3': {0: 0.007926008267161787, 1: 0.00022671027146179928, 2: 0.03413087582015025, 3: 0.006566228979080377}, 'fc4': {0: 0.2079132473495195, 1: 0.20613948599634757, 2: 0.1860467693707155, 3: 0.21050673154066604}, 'fo2': {0: 0.15156106168569367, 1: 0.15380702359048803, 2: 0.14417056172498516, 3: 0.14610853516541072}, 'fo3': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0}, 'fc2': {0: 0.009902116827287139, 1: 0.013528017033866708, 2: 0.027616689007478667, 3: 0.013844273530377201}, 'fs9': {0: 0.09858807346752954, 1: 0.09522979588991275, 2: 0.04129680866881001, 3: 0.057612571294985544}, 'fc5': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0}, 'fs10': {0: 0.08648810172192666, 1: 0.09264547998136059, 2: 0.09784316005165247, 3: 0.12213603178582898}, 'fl1': {0: 0.014196160921592382, 1: 0.00785448193063608, 2: 0.05871854742841407, 3: 0.011913062095124624}, 'fs11': {0: 1.2054050358851705e-05, 1: 0.002009944279121332, 2: 0.003718671389834701, 3: 0.000340656834094452}, 'fo5': {0: 1.2054050358851705e-05, 1: 0.002009944279121332, 2: 0.003718671389834701, 3: 0.000340656834094452}, 'fs2': {0: 0.056352185663825834, 1: 0.05233246240585956, 2: 0.041876207645730294, 3: 0.06439819637525532}, 'fs3': {0: 0.000652237152551009, 1: 0.0033211865479070876, 2: 0.003029017399214852, 3: 0.0021354778714807}, 'fs5': {0: 0.15156106168569367, 1: 0.15380702359048803, 2: 0.14417056172498516, 3: 0.14610853516541072}}}
        else:
            fault_mso_sensitivity = {10: {'fc3': {0: 0.013168985455804435, 1: 0.028984774398167993, 2: 0.032488202787092704, 3: 0.01152982309748458, 4: 0.0}, 'fc4': {0: 0.13514116454374359, 1: 0.08475568546372805, 2: 0.10505565558857474, 3: 0.05836739147156794, 4: 0.1368193851184636}, 'fl1': {0: 0.0163848599546877, 1: 0.04697844279285733, 2: 0.059387461009194994, 3: 0.02577084064607357, 4: 0.0}, 'fo2': {0: 0.09985234344041077, 1: 0.0, 2: 0.06413273927501506, 3: 0.01541700599597909, 4: 0.056679052339593874}, 'fo3': {0: 0.116224347909718, 1: 0.12748081919870108, 2: 0.08632399713706171, 3: 0.03862920239540191, 4: 0.11206314877889181}, 'fs2': {0: 0.035288821103332826, 1: 0.08475568546372805, 2: 0.04092291631355968, 3: 0.04295038547558885, 4: 0.0801403327788697}, 'fs3': {0: 0.08316242846728504, 1: 0.10552369157136224, 2: 0.11686914610324785, 3: 0.05946654990752684, 4: 0.10685915534454525}, 'fs5': {0: 0.09985234344041077, 1: 0.0, 2: 0.06413273927501506, 3: 0.01541700599597909, 4: 0.056679052339593874}, 'fs6': {0: 0.116224347909718, 1: 0.12748081919870108, 2: 0.08632399713706171, 3: 0.03862920239540191, 4: 0.11206314877889181}, 'fc2': {0: 0.21716945902763682, 1: 0.2660528114300998, 2: 0.23555352557422757, 3: 0.12062439899455328, 4: 0.23695260179075558}, 'fs9': {0: 0.049328798910150115, 1: 0.12786232526644856, 2: 0.10051057968417677, 3: 0.29233221327936265, 4: 0.06050446805062531}, 'fs10': {0: 0.018202099837102012, 1: 0.00012494521620593735, 2: 0.00829904011577209, 3: 0.02774280595746224, 4: 0.04123965467976906}, 'fs8': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.253123174387618, 4: 0.0}}, 16: {'fc1': {0: 0.49384447574726115, 1: 0.4954415596199193, 2: 0.4970322797140561, 3: 0.4853335497515736, 4: 0.4811650871336828}, 'fs2': {0: 0.0495746290882706, 1: 0.06789210973119668, 2: 0.03198065280414665, 3: 0.07142489171155976, 4: 0.015487537261002732}, 'fs3': {0: 0.13025345413569064, 1: 0.13897282688332455, 2: 0.12107324573728506, 3: 0.15530771943070815, 4: 0.13683241801305943}, 'fs5': {0: 0.14712306237420536, 1: 0.1543898498560078, 2: 0.2090757727995512, 3: 0.11458106522299905, 4: 0.18160073762445147}, 'fs6': {0: 0.14604865879502088, 1: 0.1282494233636596, 2: 0.12639412562760238, 3: 0.11232276906360034, 4: 0.12819012008352174}, 'fl1': {0: 0.03315571985955134, 1: 0.015054230545892121, 2: 0.014443923317358515, 3: 0.061030004819559086, 4: 0.05672409988428197}}, 30: {'fc1': {0: 0.23588058328221415, 1: 0.24756926609652138, 2: 0.25834508621787583, 3: 0.22855022569711117, 4: 0.26130008163908325}, 'fc5': {0: 0.0001110429186041892, 1: 0.004631748147031716, 2: 0.002166868252718735, 3: 9.37789340567761e-05, 4: 0.0026301894741569457}, 'fc3': {0: 0.03168966393759369, 1: 0.02710917432315916, 2: 0.00370027585673827, 3: 0.015119130003925025, 4: 0.019783480543327646}, 'fc4': {0: 0.04511885527771488, 1: 0.05917759107615751, 2: 0.07734058482648073, 3: 0.05636526994822994, 4: 0.06632823179665583}, 'fo2': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0, 4: 0.0}, 'fo3': {0: 0.08376199233638423, 1: 0.09738600337790146, 2: 0.09211673481623207, 3: 0.10195407863605917, 4: 0.07977715785210795}, 'fc2': {0: 0.1926285042879553, 1: 0.20110550039673838, 2: 0.18156604545586616, 3: 0.18976160454708976, 4: 0.19677131320764146}, 'fs8': {0: 0.06428565953668434, 1: 0.08371052801577826, 2: 0.03622578258537306, 3: 0.0968668760814378, 4: 0.003519728257490961}, 'fs10': {0: 0.07884240828443732, 1: 0.0, 2: 0.0843263916613822, 3: 0.06752590151699743, 4: 0.08617606557296814}, 'fl1': {0: 0.050928279607120104, 1: 0.03691650304486881, 2: 0.00370027585673827, 3: 0.017663517532548405, 4: 0.036175203799209514}, 'fs2': {0: 0.04511885527771488, 1: 0.05917759107615751, 2: 0.07734058482648073, 3: 0.05636526994822994, 4: 0.06632823179665583}, 'fs3': {0: 0.08776111999858859, 1: 0.08119834292075272, 2: 0.08888776657516308, 3: 0.06768648958419869, 4: 0.09880296873443761}, 'fs6': {0: 0.08376199233638423, 1: 0.09738600337790146, 2: 0.09211673481623207, 3: 0.10195407863605917, 4: 0.07977715785210795}, 'fs12': {0: 0.0001110429186041892, 1: 0.004631748147031716, 2: 0.002166868252718735, 3: 9.37789340567761e-05, 4: 0.0026301894741569457}}, 41: {'fc1': {0: 0.2580967234120442, 1: 0.23527401651368288, 2: 0.23784183872402828, 3: 0.2650821415725612, 4: 0.16689834534563636}, 'fl1': {0: 0.02636062425201941, 1: 0.022363717985418457, 2: 0.008232131228617889, 3: 0.0, 4: 0.012728527010671077}, 'fc3': {0: 0.020101007407966935, 1: 0.01883382227902653, 2: 0.006690681209231249, 3: 0.0, 4: 0.003471219012072393}, 'fc4': {0: 0.10567400366706114, 1: 0.10130790464600382, 2: 0.12790232786831754,
                3: 0.12182939712483543, 4: 0.0802482333377426}, 'fo2': {0: 0.10567400366706114, 1: 0.10130790464600382, 2: 0.12790232786831754, 3: 0.12182939712483543, 4: 0.0802482333377426}, 'fo3': {0: 0.07331494226683923, 1: 0.07407039331853531, 2: 0.053041384738213376, 3: 0.07882858430193233, 4: 0.032246768623842056}, 'fc2': {0: 0.15487854579134644, 1: 0.1479977690832307, 2: 0.11118203185781686, 3: 0.1470285111317509, 4: 0.09037438472411703}, 'fs9': {0: 0.0, 1: 0.010726679929080045, 2: 0.0, 3: 0.0, 4: 0.15980157737615955}, 'fs8': {0: 0.0040570711903858666, 1: 0.054572634671221205, 2: 0.08518939594780649, 3: 0.0, 4: 0.21565553747340543}, 'fs1': {0: 5.9717772841907174e-06, 1: 0.001801036120506128, 2: 0.005717491853009146, 3: 0.0003198271715234499, 4: 0.000686136411573389}, 'fs3': {0: 0.07284816063409139, 1: 0.05636582284275182, 2: 0.05535667609811075, 3: 0.06442416014579351, 4: 0.04514603538545303}, 'fs5': {0: 0.10567400366706114, 1: 0.10130790464600382, 2: 0.12790232786831754, 3: 0.12182939712483543, 4: 0.0802482333377426}, 'fs6': {0: 0.07331494226683923, 1: 0.07407039331853531, 2: 0.053041384738213376, 3: 0.07882858430193233, 4: 0.032246768623842056}}, 52: {'fc1': {0: 0.21486807070454367, 1: 0.21569122572177468, 2: 0.2172869027056597, 3: 0.20700916764110883, 4: 0.2166505290712239}, 'fc3': {0: 0.031755561209385774, 1: 0.00590697215013609, 2: 0.01376413876087217, 3: 0.018799909139042805, 4: 0.0037998296805206253}, 'fc4': {0: 0.18742699756470102, 1: 0.20132281499294716, 2: 0.19502312278490863, 3: 0.19832878081859598, 4: 0.21164282648207677}, 'fo2': {0: 0.15022458047508278, 1: 0.15384963082010325, 2: 0.15076630812915787, 3: 0.1590902881869205, 4: 0.15406563116070915}, 'fo3': {0: 0.002101922388777373, 1: 0.004872960814249948, 2: 0.0037819504788529773, 3: 0.0, 4: 0.0013008167376507029}, 'fc2': {0: 0.028365765716083697, 1: 0.01563077552770574, 2: 0.023304699835601277, 3: 0.009352204866249826, 4: 0.005739857804703433}, 'fs9': {0: 0.05093113318433347, 1: 0.08344435979089344, 2: 0.06658499239788743, 3: 0.12939830465110447, 4: 0.026369054333967187}, 'fs10': {0: 0.08770233684316289, 1: 0.097683062310279, 2: 0.09843684344052801, 3: 0.05102032912769146, 4: 0.14121611469365203}, 'fl1': {0: 0.057094711960451044, 1: 0.015402422064713647, 2: 0.032245968202770245, 3: 0.02748029596155565, 4: 0.007506715532017081}, 'fs2': {0: 0.03720241708961825, 1: 0.04747318417284392, 2: 0.044256814655750765, 3: 0.03923849263167546, 4: 0.05757719532136761}, 'fs5': {0: 0.15022458047508278, 1: 0.15384963082010325, 2: 0.15076630812915787, 3: 0.1590902881869205, 4: 0.15406563116070915}, 'fs6': {0: 0.002101922388777373, 1: 0.004872960814249948, 2: 0.0037819504788529773, 3: 0.0, 4: 0.0013008167376507029}, 'fs8': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0011919387891346305, 4: 0.018764981283751713}}, 86: {'fc1': {0: 0.26399602789571475, 1: 0.2343565497751524, 2: 0.2386676794667578, 3: 0.22866686966413358, 4: 0.29357100646663625}, 'fc3': {0: 0.009811095320732863, 1: 0.0018485311395182533, 2: 0.023014563010698916, 3: 0.012361731764613736, 4: 0.012240235578873186}, 'fc4': {0: 0.10401586895675931, 1: 0.17881559602834465, 2: 0.06318843111654912, 3: 0.10001853605462005, 4: 0.10326989098685224}, 'fo2': {0: 0.04451929600752442, 1: 0.10710805749710707, 2: 0.027790332247016793, 3: 0.03687180637909654, 4: 0.021247603412294248}, 'fo3': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0, 4: 0.0}, 'fc2': {0: 0.18334402576437184, 1: 0.06952757890260819, 2: 0.20448547323161076, 3: 0.15545133811428583, 4: 0.2144080767460622}, 'fs9': {0: 0.11652172448129894, 1: 0.1583698542810033, 2: 0.14537196909188616, 3: 0.12688705504547257, 4: 0.02224043894849313}, 'fc5': {0: 0.0, 1: 0.0, 2: 0.0, 3: 0.0, 4: 0.0}, 'fs10': {0: 0.0, 1: 0.0, 2: 0.02702089945466387, 3: 0.051880099367149594, 4: 0.02491350155070486}, 'fl1': {0: 0.05627426820144159, 1: 0.019149082332662885, 2: 0.0807101883008026, 3: 0.0555211989060951, 4: 0.08010539004388606}, 'fs11': {0: 0.001992419178575095, 1: 0.006884375730797792, 2: 0.004389204951680034, 3: 0.023416981090940456, 4: 0.0011490021322871974}, 'fo5': {0: 0.001992419178575095, 1: 0.006884375730797792, 2: 0.004389204951680034, 3: 0.023416981090940456, 4: 0.0011490021322871974}, 'fs2': {0: 0.0594965729492349, 1: 0.07170753853123757, 2: 0.03539809886953232, 3: 0.0631467296755235, 4: 0.082022287574558}, 'fs3': {0: 0.11351698605824667, 1: 0.03824040255366312, 2: 0.11778362306010502, 3: 0.08548886646803218, 4: 0.12243596101477117}, 'fs5': {0: 0.04451929600752442, 1: 0.10710805749710707, 2: 0.027790332247016793, 3: 0.03687180637909654, 4: 0.021247603412294248}}}
        
        # d=["2021-05-25T12:30:00.000Z","2021-05-26T09:30:00.000Z"] #val 1
        # d=["2021-05-26T10:00:00.000Z","2021-05-27T13:00:00.000Z"] #obstruction
        # d=["2021-05-28T14:00:00.000Z","2021-05-29T14:00:00.000Z"] #High Temp
        # d=["2021-06-01T01:00:00.000Z","2021-06-04T10:00:00.000Z"]
        
        # dates_goal=[["2021-05-25T12:30:00.000Z","2021-05-26T09:30:00.000Z"],
        #            ["2021-05-26T10:00:00.000Z","2021-05-27T13:00:00.000Z"],
        #            ["2021-05-28T14:00:00.000Z","2021-05-29T14:00:00.000Z"],
        #            ["2021-05-31T08:30:00.000Z","2021-06-01T12:00:00.000Z"],
        #            ["2021-06-01T12:00:00.000Z","2021-06-03T07:50:00.000Z"],
        #            ["2021-06-03T07:50:00.000Z","2021-06-03T11:40:00.000Z"]]
        sensors={"1":"ControlRegCompAC.VarFrequencyHzMSK","2":"EbmpapstFan_1_Mng.InfoSpeed_EBM_1.CurrSpeed","3":"Data_EVD_Emb_1.EVD.Variables.EEV_PosPercent.Val","7":"WaterFlowMeter","8":"SuctSH_Circ1","9":"DscgTempCirc1","12":"EvapTempCirc1","13":"CondTempCirc1","16":"W_OutTempUser","17":"W_OutTempEvap","18":"W_InTempUser","20":"FiltPress","23":"PumpPress","24":"ExtTemp"}
        var_names=['ControlRegCompAC.VarFrequencyHzMSK',
         'EbmpapstFan_1_Mng.InfoSpeed_EBM_1.CurrSpeed',
         'Data_EVD_Emb_1.EVD.Variables.EEV_PosPercent.Val',
         'WaterFlowMeter',
         'SuctSH_Circ1',
         'DscgTempCirc1',
         'EvapTempCirc1',
         'CondTempCirc1',
         'W_OutTempUser',
         'W_OutTempEvap',
         'W_InTempUser',
         'FiltPress',
         'PumpPress',
         'ExtTemp']
        
        dates_goal = [["2021-05-19T15:45:00.000Z","2021-05-20T10:10:00.000Z"],["2021-05-21T12:45:00.000Z","2021-05-22T08:10:00.000Z"],["2021-05-23T12:45:00.000Z","2021-05-24T07:10:00.000Z"],["2021-05-28T14:00:00.000Z","2021-05-29T14:00:00.000Z"]]#["2021-05-19T16:30:00.000Z","2021-05-26T08:30:00.000Z"]
        names_analysis = ['models_error', 'low_bounds', 'high_bounds',
            'activations', 'confidence', 'group_prob', 'timestamp']
        host = 'https://elastic-telemetrydb-prod-weu-001.es.westeurope.azure.elastic-cloud.com:9243'
        client = Elasticsearch(hosts=[host], http_auth=('laudaelastic', 'BBQvlxaXFKHldJjQ3At1'))
        # data_issue=get_analytics(client,d[0],d[1],device,v,names_analysis)
        data_iss = []
        for d in dates_goal:
            print('- Getting the analitics from '+d[0])
            data_iss.append(get_analytics(
                client, d[0], d[1], device, v, names_analysis))
        mso_set = [10, 16, 30, 41, 52, 86]
        faults = {1: 'fc1', 2: 'fc2', 3: 'fc3', 4: 'fc4', 6: 'fc5', 8: 'fl1', 10: 'fo2', 11: 'fo3', 12: 'fo4', 13: 'fo5',
            19: 'fs1', 20: 'fs2', 21: 'fs3', 22: 'fs5', 23: 'fs6', 24: 'fs8', 25: 'fs9', 26: 'fs10', 27: 'fs11', 28: 'fs12'}
        fault_signature_matrix = [[0, 1, 1, 1, 1, 1], [1, 0, 1, 1, 1, 1], [1, 0, 1, 1, 1, 1], [1, 0, 1, 1, 1, 1], [0, 0, 1, 0, 0, 1], [1, 1, 1, 1, 1, 1], [1, 0, 1, 1, 1, 1], [1, 0, 1, 1, 1, 1], [0, 0, 0, 0, 0, 0], [
            0, 0, 0, 0, 0, 1], [0, 0, 0, 1, 0, 0], [1, 1, 1, 0, 1, 1], [1, 1, 1, 1, 0, 1], [1, 1, 0, 1, 1, 1], [1, 1, 1, 1, 1, 0], [1, 0, 1, 1, 1, 0], [1, 0, 0, 1, 1, 1], [1, 0, 1, 0, 1, 1], [0, 0, 0, 0, 0, 1], [0, 0, 1, 0, 0, 0]]
        priori = np.ones(len(faults))/len(faults)
        
        training_data_stats={'CondTempCirc1': {'count': 119999.0, 'mean': 35.40744006200052, 'std': 8.90832861902754, 'min': 21.7, '25%': 28.6, '50%': 33.5, '75%': 39.6, 'max': 61.9}, 'ControlRegCompAC.VarFrequencyHzMSK': {'count': 119999.0, 'mean': 117.20713672613937, 'std': 48.016148138679334, 'min': 0.0, '25%': 79.0, '50%': 114.6, '75%': 157.6, 'max': 200.0}, 'Data_EVD_Emb_1.EVD.Variables.EEV_PosPercent.Val': {'count': 119999.0, 'mean': 59.985982383186524, 'std': 25.939489172746487, 'min': 0.0, '25%': 41.3, '50%': 59.4, '75%': 80.0, 'max': 100.0}, 'DscgTempCirc1': {'count': 119999.0, 'mean': 64.29948166234719, 'std': 13.256771386645704, 'min': 39.7, '25%': 53.6, '50%': 62.3, '75%': 74.2, 'max': 101.3}, 'EbmpapstFan_1_Mng.InfoSpeed_EBM_1.CurrSpeed': {'count': 119999.0, 'mean': 113.43869365578045, 'std': 17.538777345983736, 'min': 0.0, '25%': 107.3, '50%': 113.4, '75%': 120.6, 'max': 163.7}, 'EvapTempCirc1': {'count': 119999.0, 'mean': 6.837542812856774, 'std': 10.973930126348929, 'min': -18.6, '25%': -2.5, '50%': 8.8, '75%': 17.1, 'max': 27.0}, 'ExtTemp': {'count': 119999.0, 'mean': 27.026118550987924, 'std': 9.114370111131533, 'min': 17.4, '25%': 22.0, '50%': 22.9, '75%': 24.6, 'max': 53.2}, 'FiltPress': {'count': 119999.0, 'mean': 0.5030391919932666, 'std': 0.22608007119671195, 'min': 0.1, '25%': 0.3, '50%': 0.5, '75%': 0.7, 'max': 0.9}, 'PumpPress': {'count': 119999.0, 'mean': 4.333651113759282, 'std': 0.15663738666291355, 'min': 4.0, '25%': 4.2, '50%': 4.3, '75%': 4.5, 'max': 4.6}, 'SuctSH_Circ1': {'count': 119999.0, 'mean': 9.598460820506837, 'std': 5.357339488874387, 'min': 1.1, '25%': 6.3, '50%': 7.6, '75%': 9.9, 'max': 33.5}, 'UnitStatus': {'count': 119999.0, 'mean': 9.0, 'std': 0.0, 'min': 9.0, '25%': 9.0, '50%': 9.0, '75%': 9.0, 'max': 9.0}, 'W_InTempUser': {'count': 119999.0, 'mean': 17.239367828065234, 'std': 14.581572713808185, 'min': -10.6, '25%': 4.7, '50%': 17.1, '75%': 29.2, 'max': 51.7}, 'W_OutTempEvap': {'count': 119999.0, 'mean': 12.814576788139899, 'std': 13.394501890590526, 'min': -12.3, '25%': 1.3, '50%': 12.6, '75%': 24.1, 'max': 39.5}, 'W_OutTempUser': {'count': 119999.0, 'mean': 13.341140342836189, 'std': 13.105144081605985, 'min': -11.2, '25%': 2.3, '50%': 13.0, '75%': 24.2, 'max': 39.4}, 'WaterFlowMeter': {'count': 119999.0, 'mean': 46.13294277452312, 'std': 12.478756683077693, 'min': 21.1, '25%': 33.3, '50%': 47.3, '75%': 58.5, 'max': 69.0}}
        bins={}
        bin_size=50
        labels=[]
        for i in range(bin_size):
            labels.append(i)
        for var in var_names:
            bb=[training_data_stats[var]['min']-1000*training_data_stats[var]['std']+(i/(bin_size-1))*(training_data_stats[var]['max']-training_data_stats[var]['min'])]
            for i in range(bin_size-1):
                bb.append(training_data_stats[var]['min']+(i/(bin_size-1))*(training_data_stats[var]['max']-training_data_stats[var]['min']))
            bb.append(training_data_stats[var]['min']+1000*training_data_stats[var]['std']+((i+1)/(bin_size-1))*(training_data_stats[var]['max']-training_data_stats[var]['min']))                 
            bins[var]= bb
        
        activations = []
        confidences = []
        error = []
        high = []
        low = []
        groups = []
        telemetry ={}
        for i in range(len(mso_set)):
            for d in range(len(data_iss)):
                if d == 0:
                    activations.append(data_iss[d][i]['activations'])
                    confidences.append(data_iss[d][i]['confidence'])
                    error.append(data_iss[d][i]['models_error'])
                    high.append(data_iss[d][i]['high_bounds'])
                    low.append(data_iss[d][i]['low_bounds'])
                    groups.append(data_iss[d][i]['group_prob'])
                else:
                    activations[i] = activations[i]+data_iss[d][i]['activations']
                    confidences[i] = confidences[i]+data_iss[d][i]['confidence']
                    error[i] = error[i]+data_iss[d][i]['models_error']
                    high[i] = high[i]+data_iss[d][i]['high_bounds']
                    low[i] = low[i]+data_iss[d][i]['low_bounds']
                    groups[i] = groups[i]+data_iss[d][i]['group_prob']
        
        times = data_iss[0][0]['timestamp']
        for d in data_iss[1:]:
            times = times+d[0]['timestamp']
        first=True
        for d in dates_goal:
            print('- Getting the telemetry from '+d[0])
            client = Elasticsearch(hosts=[host], http_auth=('laudaelastic', 'BBQvlxaXFKHldJjQ3At1'))
            if first:
                first=False
                for var in var_names:
                    elm=get_telemetry(client,d[0],d[1],device,var)
                    keep=pd.DataFrame(list(elm.keys())).isin(times)
                    telemetry[var]=pd.DataFrame(list(elm.values()))[keep.values]
            else:
                for var in var_names:
                    elm=get_telemetry(client,d[0],d[1],device,var)
                    keep=pd.DataFrame(list(elm.keys())).isin(times)
                    telemetry[var]=telemetry[var].append(pd.DataFrame(list(elm.values()))[keep.values],ignore_index=True)
    
    # normalize the telemetry
    def norm(x,train_stats):
        y={}
        for name in x.columns:
            y[name]=[]
            for i in x.index:
                a=float((x.loc[i,name]-train_stats.loc[name,'mean'])/train_stats.loc[name,'std'])
                y[name].append(a)  #.apply(lambda num: (num-train_stats.loc[name,'mean'])/train_stats.loc[name,'std'])
        return pd.DataFrame(y)
    
    if True:
        solvers.options['feastol']=1e-6
        data_dic={}
        for var in var_names:
            data_dic[var]=telemetry[var].values.flatten()
        data_train=pd.DataFrame(data_dic) 
        train_stats=data_train.describe()
        train_stats = train_stats.transpose()
        copy_train=copy.deepcopy(data_train)
        
        normed_train_data_o = norm(data_train,train_stats)
        # prepare data to form phi and e --> Filtered to 1 region from 1 MSO
        #e=np.abs(np.matrix([0.5,0.2,-0.4,0.8,0.6,0.1,-0.3,0.7]))
        #phi=np.matrix([[0.8,2],[0.1,1.2],[0.3,0.9],[0.6,3],[0.3,1.6],[0.4,2.1],[0.1,0.7],[0.6,2]])
        mso=0
        group= 0
        source=['Data_EVD_Emb_1.EVD.Variables.EEV_PosPercent.Val', 'SuctSH_Circ1', 'ControlRegCompAC.VarFrequencyHzMSK', 'CondTempCirc1', 'EbmpapstFan_1_Mng.InfoSpeed_EBM_1.CurrSpeed', 'DscgTempCirc1', 'ExtTemp', 'W_OutTempEvap', 'W_OutTempUser', 'W_InTempUser']
        objective='EvapTempCirc1'
        # find the samples belonging to one group
        selection=[]
        i=-1
        for prob in groups[mso]:
            i=i+1
            if prob[group]==1:
                selection.append(i)
                
        size=len(selection) # reduce the size to avoid the memory issues 
        offset=1000
        sets=10
        selection=random.sample(selection, size)
        # select the error
        e=np.abs(np.take(np.matrix(error[0]),selection))
        # order it and start taking sets
        order=np.argsort(e)
        selection=order
        e=np.take(e,order)
        # rearrange for telemetry
        for name in source:
            if name==source[0]:
                phi=np.matrix(np.take(normed_train_data_o[name].values,selection)).T
            else:
                phi=np.concatenate((phi,np.matrix(np.take(normed_train_data_o[name].values,selection)).T),axis=1)

else:
    with open('error.pkl', 'rb') as handle:
        e = pickle.load(handle)
    with open('phi.pkl', 'rb') as handle:
        phi = pickle.load(handle)

# plot tools
def moving_average(a, n=20) :
    ret = np.cumsum(a, dtype=float)
    ret[n:] = ret[n:] - ret[:-n]
    return ret[n - 1:] / n

def scatter_hist(x, y, ax, ax_histx, ax_histy):
    # no labels
    ax_histx.tick_params(axis="x", labelbottom=False)
    ax_histy.tick_params(axis="y", labelleft=False)

    # the scatter plot:
    ax.scatter(x, y)

    # now determine nice limits by hand:
    binwidth = 0.25
    xymax = max(np.max(np.abs(x)), np.max(np.abs(y)))
    lim = (int(xymax/binwidth) + 1) * binwidth

    bins = np.arange(-lim, lim + binwidth, binwidth)
    ax_histx.hist(x, bins=bins)
    ax_histy.hist(y, bins=bins, orientation='horizontal')
    
def format_axes(fig):
    for i, ax in enumerate(fig.axes):
        ax.text(0.5, 0.5, "ax%d" % (i+1), va="center", ha="center")
        ax.tick_params(labelbottom=False, labelleft=False)
        
def confidence_ellipse(x, y, ax, n_std=3.0, facecolor='none', **kwargs):
    """
    Create a plot of the covariance confidence ellipse of *x* and *y*.

    Parameters
    ----------
    x, y : array-like, shape (n, )
        Input data.

    ax : matplotlib.axes.Axes
        The axes object to draw the ellipse into.

    n_std : float
        The number of standard deviations to determine the ellipse's radiuses.

    **kwargs
        Forwarded to `~matplotlib.patches.Ellipse`

    Returns
    -------
    matplotlib.patches.Ellipse
    """
    if x.size != y.size:
        raise ValueError("x and y must be the same size")
    cov = np.cov(x, y)
    pearson = cov[0, 1]/np.sqrt(cov[0, 0] * cov[1, 1])
    # Using a special case to obtain the eigenvalues of this
    # two-dimensionl dataset.
    ell_radius_x = np.sqrt(1 + pearson)
    ell_radius_y = np.sqrt(1 - pearson)
    ellipse = Ellipse((0, 0), width=ell_radius_x * 2, height=ell_radius_y * 2,
                      facecolor=facecolor, **kwargs)
    # Calculating the stdandard deviation of x from
    # the squareroot of the variance and multiplying
    # with the given number of standard deviations.
    scale_x = np.sqrt(cov[0, 0]) * n_std
    mean_x = np.mean(x)
    # calculating the stdandard deviation of y ...
    scale_y = np.sqrt(cov[1, 1]) * n_std
    mean_y = np.mean(y)
    transf = transforms.Affine2D() \
        .rotate_deg(45) \
        .scale(scale_x, scale_y) \
        .translate(mean_x, mean_y)
    ellipse.set_transform(transf + ax.transData)
    return ax.add_patch(ellipse) 
# the LP fast case ... only lower limit could be found
def option_C(e,phi, m=1,sigma=1,alpha=1,beta=0.00001):
    solvers.options['show_progress'] = True
    n = phi.shape[1]
    k =phi.shape[0]
    z_l=m*n+m*k
    # q must allow that only the t elements are represented in the minimization (so far) ... P can be used later for regularization
    q_com=np.zeros([z_l,1])
    q_com[m*n:,:]=1
    q = matrix(q_com)
    # G will contain three parts: 1st for the error bounds and then the two limits for the absolute value conversion through t
    g_com=np.zeros([(2*m+1)*k,z_l])
    for i in range(m):
        inn=m*n+i*k
        #for the sigma ... error bound check
        g_com[:k,i*n:(i+1)*n]=-phi
        # for the g1 conditions
        g_com[k*(1+i):(2+i)*k,i*n:(i+1)*n]=phi
        g_com[k*(1+i):(2+i)*k,inn:(inn+k)]=-np.identity(k)
        # for the g2 conditions
        g_com[k*(m+i+1):(m+i+2)*k,i*n:(i+1)*n]=-phi
        g_com[k*(m+i+1):(m+i+2)*k,inn:(inn+k)]=-np.identity(k)
    G = matrix(g_com)
    # h is just the error and a lot of 0s
    h_com=np.zeros([(2*m+1)*k,1])
    h_com[:k,:]=-sigma*e.T
    h=matrix(h_com)
    # no linear equalities so far ...
    #A = matrix(0.0, (3*k,z_l))
    #b = matrix(0.0, (3*k,1))
    # from numpy.linalg import matrix_rank
    # matrix_rank([P,A, G])
    res = solvers.lp(q, G, h) #, A, b
    #print(res['x'])
    z=np.array(list(res['x']))
    x=z[:n]
    t=z[n:]
    return res
        
def single_point_cross(p1,p2):
    sp1=p1['signature']
    sp2=p2['signature']
    crispr=np.random.randint(0,(len(sp1)-1))
    ch1=np.concatenate((sp1[0:crispr],sp2[crispr:len(sp1)]))
    ch2=np.concatenate((sp2[0:crispr],sp1[crispr:len(sp1)]))
    return ch1, ch2
    
# Set the mutation with the given rate mu (all rand num smaller than mu are mutated). For each element in the signature the mutation is applied:
def mutate(sig,mu):
    dices=np.random.random(len(sig))
    mu_list=np.where(dices<mu)[0]
    a=np.zeros(len(sig))
    a[mu_list]=1
    result=abs(sig-a)
    if sum(result)==0:
        result[np.random.choice(int(len(result)-1), 1)]=1
    return np.array(result,dtype=int)

def prepare_H(pop,chosen):
    go_to=np.where(chosen==1)[0]
    H_x=np.matrix(pop[go_to[0]])
    for i in range(1,len(go_to)):
        H_x=np.concatenate((H_x,np.matrix(pop[go_to[i]])),axis=0)
    return H_x

# the bigger the ascending tendency the bigger the reward 
def h_leaning(b,n=10):
    reward=0
    b=b/np.mean(b)
    k=b.shape[0]
    st=int(k/n)
    last=np.mean(b[:st])
    for i in range(1,n-1):
        new=np.mean(b[i*st:(i+1)*st])
        #print(last)
        step=new-last
        if step<0:
            step=0
        reward=reward+step
        last=new
    return 1/reward
        
def ranking_h(pop,phi):
    scores=[]
    for p in pop:
        H_x=np.matrix(p)
        bound=np.ravel(np.matmul(phi,H_x.T))
        scores.append(h_leaning(bound))
    # get rid of values smaller than 0
    scores=np.array(scores)
    least=min(abs(scores))
    scores[scores<0]=least/2
    return scores/sum(scores)

# 4 elements to evaluate how well it works
def sig_cost(sig_P,pop,err,phi,epsi=50,gamma=2.5,thet=0.4,show=False):
    H_x=prepare_H(pop,sig_P)
    many_bounds=np.matmul(phi,H_x.T)
    df_est=pd.DataFrame(many_bounds.T)
    #stats=df_est.describe().transpose()
    bound=np.ravel(np.sum(many_bounds,axis=1)/many_bounds.shape[1])
    dif=np.ravel(err-bound)
    #l=len(dif[dif<0])
    n=many_bounds.shape[0]
    homog=gamma*np.std(dif)/np.std(bound)
    squares=thet*np.sum((dif/np.mean(np.abs(dif)))**4)/n
    dif[dif<0]=-epsi*dif[dif<0]
    sums=np.sum(dif)/n
    tendency=h_leaning(bound)
    total_cost=(sums+homog+squares)*tendency
    #up=bound+lims*np.ravel(stats['std'].values)
    #low=bound-lims*np.ravel(stats['std'].values) 
    if show:
        print('   [D] Total costs: {} |  diff: {} | homogeneity: {} | squares: {} | tendency: {}'.format(total_cost,sums,homog,squares,tendency))
    return total_cost

def find_nearest(array, value):
    idx = (np.abs(array - value)).argmin()
    return idx

def ga_search(pop,err,phi,nP=500,nI=500,pC=1,mu_o=0.075,lims=0.5,in_spyder=False,seeds='seeds.pkl'):
    mu=mu_o
    n=len(pop)
    parents=pd.DataFrame({'cost':[],'signature':[]})
    xs=np.linspace(0,err.shape[1]-1,err.shape[1])
    t_a=datetime.datetime.now()
    print('START CREATING EVA POPULATION')
    #load seeds that worked well before
    unseeded=False
    try:
        with open(seeds, 'rb') as handle:
            init = pickle.load(handle)
    except:
        print(' ----- NO SEED DATA -----')
        unseeded=True
        init=[]
    # now not so random - we prefer the ones that go in the direction of the ascending error
    scores=ranking_h(pop,phi)
    prob_sc=np.cumsum(scores)
    #initialize parents
    for i in range(nP):
        # we use previous results to speed up 
        sig_P=np.zeros(n)
        if i<len(init):
            for m in init[i]:
                sig_P[m]=1
        else:
            siz=np.random.choice(int(n/20), 1)
            if sum(siz)==0:
                siz=np.array([4])
            rands=np.random.random(siz)
            #select=np.random.choice(n, siz)
            for m in rands:
                pos=find_nearest(prob_sc,m)
                sig_P[pos]=1
        cost_P=sig_cost(sig_P,pop,err,phi)
        parents=parents.append({'cost':cost_P,'signature':sig_P},ignore_index=True)   
    t_b=datetime.datetime.now()
    dif=t_b-t_a
    print('END CREATING EVA POPULATION | time: {}'.format(dif))
    parents=parents.sort_values('cost')
    # TO CALL THIS COST is: best_ever['cost']
    best_ever=parents.iloc[0]
    #start the "culture"
    nC=nP*pC
    stop_1=True
    stop_2=True
    stop_3=True
    t_a=datetime.datetime.now()
    for i in range(nI):
        t_a=datetime.datetime.now()
        #t_a=datetime.datetime.now()
        #t_a=datetime.datetime.now()
        children=pd.DataFrame({'cost':[],'signature':[]})
        for j in range(math.floor(nC/2)):
            #select parents
            handmaids=np.random.permutation(nP)[0:2]
            #crossbreed - currently only SPC but it could be an option among different methods
            ch1_sig,ch2_sig=single_point_cross(parents.iloc[handmaids[0]],parents.iloc[handmaids[1]])
            # mutate with mu rate
            ch1_mut=mutate(ch1_sig,mu)
            ch2_mut=mutate(ch2_sig,mu)
            # evaluate children and load the table of children
            ch1_cost=sig_cost(ch1_mut,pop,err,phi)
            ch2_cost=sig_cost(ch2_mut,pop,err,phi)
            children=children.append({'cost':ch1_cost,'signature':ch1_mut},ignore_index=True)
            children=children.append({'cost':ch2_cost,'signature':ch2_mut},ignore_index=True)
        # mix with parents in new population, sort, check best and do all over again
        i_mix=parents.append(children,ignore_index=True)
        i_mix=i_mix.sort_values('cost')
        if i_mix.iloc[0]['cost']==best_ever['cost']:
            mu=mu*0.1
            if mu>0.15:
                mu=0.15
        else:
            mu=mu_o
        best_ever=i_mix.iloc[0]
        # set parents as the best among the new mix
        parents=i_mix.iloc[0:nP]
        parents.head(10)
        t_c=datetime.datetime.now()
        dif=t_c-t_a
        print(' [I] TOTAL TIME OF ITERATION #'+str(i)+' | is:  '+str(dif))
        #print(best_ever)
        #sum(best_ever['signature'])
        if (i%5)==0:
            print('Completed Iteration #'+str(i))
            t_b=datetime.datetime.now()
            dif=t_b-t_a
            print('   [I] TOTAL TIME OF ITERATION #'+str(i)+' | is:  '+str(dif))
            print(list(np.where(best_ever['signature']==1)[0]))
            if in_spyder:
                H_x=prepare_H(pop,best_ever['signature'])
                many_bounds=np.matmul(phi,H_x.T)
                df_est=pd.DataFrame(many_bounds.T)
                #stats=df_est.describe().transpose()
                bound=np.ravel(np.sum(many_bounds,axis=1)/many_bounds.shape[1])
                #up=bound+lims*np.ravel(stats['std'].values)
                #low=bound-lims*np.ravel(stats['std'].values) 
                fig = plt.figure(figsize=(15.0, 15.0))
                ma=moving_average(np.ravel(bound),n=100)
                plt.plot(xs, np.ravel(err), "-", linewidth=2, color='gold', alpha=0.8,label='real error')
                plt.plot(xs[:len(ma)], ma, "-", linewidth=2, color='crimson', alpha=0.5,label='bound')
                #plt.fill_between(xs, np.ravel(up), np.ravel(low), "-", linewidth=2, color='crimson', alpha=0.2,label='bound')
                plt.legend()
                plt.title('Round #{}'.format(i))
                plt.show()
            print('   [I] Number of h_i used: '+str(sum(best_ever['signature'])))
            sig_cost(best_ever['signature'],pop,err,phi,show=True)
            #t_a=datetime.datetime.now()
        #sig_cost(cm,fault_activations,children.iloc[3]['signature'],detectable_faults,show=True)
        #t_b=datetime.datetime.now()
        #dif=t_b-t_a
        #☺print('   [I] total time of iteration is:  '+str(dif))
    with open('resulting_H.pkl', 'wb') as handle:
        pickle.dump(parents.head(100), handle, protocol=pickle.HIGHEST_PROTOCOL)
        
    # last save of seeds for next runs
    next_seeds=[]
    for i in range(20):
        next_seeds.append(list(np.where(parents.iloc[i]['signature']==1)[0]))
    with open(seeds, 'wb') as handle:
        pickle.dump(next_seeds, handle, protocol=pickle.HIGHEST_PROTOCOL)
    return best_ever

# plot the features of a population of Xs
def plots_X(estims,n):
    exes={}
    for j in range(estims[0].shape[0]):
        name='X_'+str(j)
        exes[name]=[]
    for i in range(len(estims)):
        for j in range(estims[0].shape[0]):
            name='X_'+str(j)
            exes[name].append(estims[i][j])
    dfx=pd.DataFrame(exes)
    z_names=[]
    for j in range(estims[0].shape[0]):
        name='X_'+str(j)
        dfx[name+'_Zscore'] = (dfx[name]-dfx[name].mean())/dfx[name].std()
        z_names.append(name+'_Zscore')
    # 1D distributions of xs
    fig = plt.figure(figsize=(15.0, 15.0))
    fig.suptitle('Individual X parameter analysis')
    fig, axes = plt.subplots(n // 2, 2, figsize=(10, 10))
    for i in range(len(z_names)):
        name='X_'+str(i)
        r, c = i // 2, i % 2
        axes[r, c].set_xlim([-2.5, 2.5])
        a1 = axes[r, c]
        a2 = a1.twinx()
        dfx[z_names[i]].plot.hist(ax=a2,bins=50, alpha=.3)
        dfx[z_names[i]].plot.kde(title=name, ax=a1, c='r')
    fig.tight_layout()
    plt.show()
    # correlation matrix
    fig = plt.figure(figsize=(15.0, 15.0))
    dfx=pd.DataFrame(exes)
    cor=dfx.corr()
    sns.heatmap(cor, xticklabels=dfx.columns,yticklabels=dfx.columns,cmap='Spectral')
    # 2D cross values 
    fig = plt.figure(figsize=(15.0, 15.0))
    fig.suptitle('Pair X parameter analysis')
    fig, axes = plt.subplots(n , n, figsize=(10, 10))
    for i in range(len(z_names)):
        for j in range(len(z_names)):
            name='X_'+str(i)+' vs X_'+str(j)
            #axes[r, c].set_xlim([-2.5, 2.5])
            confidence_ellipse(dfx['X_'+str(i)], dfx['X_'+str(j)], axes[i,j], edgecolor='red')
            axes[i,j].scatter(dfx['X_'+str(i)], dfx['X_'+str(j)], c='blue', s=2, alpha=0.2)
            axes[i,j].tick_params(axis='x', labelsize=6)
            axes[i,j].tick_params(axis='y', labelsize=6)
    plt.tight_layout()
    plt.show()
    
    
# generate a population of optimal projections where we can search for the best subset 
not_recorded=False
# 1 - N=15 samples to fit projection in Opt, 2 - N=[10,20,40,80,160,320] evenly distributed
populations=['population_pool.pkl','population_pool_2.pkl']
selected_pop=0
try:
    with open(populations[selected_pop], 'rb') as handle:
        estims = pickle.load(handle)
except:
    not_recorded=True
    
if not_recorded:
    E=1500
    S=40000
    pfi=phi[-S:-E,:]
    er=e[:,-S:-E]
    m=10000
    N=[10,20,40,80,160,320]
    n = phi.shape[1]
    #k = N
    #z_l=n+k
    results={}
    estims=[]
    #fig = plt.figure(figsize=(15.0, 15.0))
    for i in range(m):
        p_N=N[int(np.floor(i*len(N)/m))]
        k=p_N
        z_l=n+p_N
        subset=np.random.choice(er.shape[1], p_N)
        # select the error
        err=np.abs(np.take(er,subset))
        fi=pfi.take(subset,axis=0)
        # order it and start taking sets
        order=np.argsort(err)
        subset=order
        err=np.take(err,order)
        fi=pfi.take(subset,axis=0)
        reduction=0.1 
        mav=1
        xs=np.linspace(0,err.shape[1]-1,err.shape[1])
        colours=iter(CM.Spectral(np.linspace(0,1,(m))))
        #ax_e = fig.add_subplot(5,2,i+1)
        og_c='gold'
        print(err[err == 0].shape)
        ############ OPTIMIZATION #############
        res=option_C(err,fi)
        z=np.array(list(res['x']))
        #ax_e.plot(xs, np.ravel(err), "-", linewidth=2, color=og_c, alpha=0.6,label='real error stage #'+str(i))
        results[i]=z
        x=z[:n]
        t=z[n:]
        pff=np.zeros([n,k]).T
        c=next(colours)
        pff=fi
        estims.append(x)
    #plots_X(estims,n) 
    with open(populations[selected_pop], 'wb') as handle:
        pickle.dump(estims, handle, protocol=pickle.HIGHEST_PROTOCOL)

# launch the search
E=100
S=40000
#best_ever=ga_search(estims,e[:,-S:-E],phi[-S:-E,:],seeds='seeds_141221_newPop_4Cost.pkl',nP=100,nI=50,in_spyder=True) #,nP=10,nI=10,in_spyder=True,
#'seeds_131221.pkl','seeds_131221_variableNpop.pkl','seeds_131221_extraCost.pkl',
# FINAL RUN WITH ranged N | 'seeds_141221_newPop_4Cost.pkl'
# FINAL RUN WITH N=15 | 'seeds_141221_extraCost.pkl'